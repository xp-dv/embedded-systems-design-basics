//* Lab 0 - C Programming Refresher | Part 1 - EDID Decoder and Writer

// TASK #1: Parse the EDID and display the following
/**
 * Video Interface
 * Audio Format Code
 * Supported Maximum Channels
 * Supported Sample Frequencies
 * Supported Bit Depth
 */

// TASK #2: Write the following data to the EDID block
/**
 * Video Interface = DisplayPort
 * Audio Format Code (Unchanged)
 * Supported Maximum Channels = 2
 * Supported Sample Frequencies = 48 kHz (only)
 * Supported Bit Depth = 24-bit (only)
 */

//* Local Headers
#include "edid_decoder.h"

//* Standard Headers
#include <stdint.h>

//* Main
int main() {
  uint8_t edid[256] = {
    0x00,0xff,0xff,0xff,0xff,0xff,0xff,0x00, 0x0a,0x13,0x45,0x32,0x00,0x00,0x00,0x00,
    0x00,0x18,0x01,0x03,0x80,0x00,0x00,0x78, 0x1e,0xee,0x91,0xa3,0x54,0x4c,0x99,0x26,
    0x0f,0x50,0x54,0xff,0xff,0x80,0xd1,0xc0, 0xa9,0x40,0xb3,0x00,0x90,0x40,0x81,0x40,
    0x81,0x80,0x81,0x00,0x61,0x40,0x02,0x3a, 0x80,0x18,0x71,0x38,0x2d,0x40,0x58,0x58,
    0x45,0x00,0x00,0x00,0x00,0x00,0x00,0x1e, 0x02,0x3a,0x80,0xd0,0x72,0x38,0x2d,0x40,
    0x10,0x2c,0x45,0x80,0x00,0x00,0x00,0x00, 0x00,0x1e,0x00,0x00,0x00,0xfc,0x00,0x45,
    0x32,0x0a,0x20,0x20,0x20,0x20,0x20,0x20, 0x20,0x20,0x20,0x20,0x00,0x00,0x00,0xfd,
    0x00,0x17,0x78,0x0f,0xa0,0x3c,0x00,0x0a, 0x20,0x20,0x20,0x20,0x20,0x20,0x01,0xaf,

    0x02,0x03,0x35,0xF2,0x23,0x0D,0x16,0x07, 0x6D,0x03,0x0C,0x00,0x10,0x00,0xB8,0x42,
    0x20,0x00,0x60,0x03,0x02,0x01,0x67,0xD8, 0x5D,0xC4,0x01,0x77,0x80,0x00,0x51,0x90,
    0x05,0x04,0x13,0x14,0x9F,0x20,0x5D,0x5E, 0x5F,0x60,0x61,0x62,0x63,0x64,0x65,0x66,
    0xE4,0x0F,0x00,0xFC,0x0F,0x02,0x3A,0x80, 0x18,0x71,0x38,0x2D,0x40,0x58,0x2C,0x45,
    0x00,0x00,0x00,0x00,0x00,0x00,0x1E,0x01, 0x1D,0x00,0x72,0x51,0xD0,0x1E,0x20,0x6E,
    0x28,0x55,0x00,0x00,0x00,0x00,0x00,0x00, 0x1E,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x24,0x00,0x00,0x24
    // Note: Example EDID does not have valid checksums
  };

  decode_edid(edid); // Decode and print original EDID information

  // Save EDID information to change
  uint8_t set_video_interface = set_bits(VIDEO_INTERFACE_MASK, edid[VIDEO_INTERFACE_BYTE], 0x05U); // Set video interface = DisplayPort (bits 3-0 = 5)
  uint8_t sad_channel_byte = 133U; // DBC byte 1
  uint8_t set_sad_channel = set_bits(SAD_CHANNEL_MASK, edid[sad_channel_byte], 0x01U); // Set supported audio channels = 2 (bits 2-0 = 0x01)
  uint8_t sad_sample_freq_byte = sad_channel_byte + 1U;
  uint8_t set_sad_sample_freq_data = set_bits(0x7FU, edid[sad_sample_freq_byte], 0x04U); // Set supported sample frequencies = 48 kHz only (set bit 2, reset all others)
  uint8_t sad_bit_depth_byte = sad_sample_freq_byte + 1U;
  uint8_t set_sad_bit_depth = set_bits(0x07U, edid[sad_bit_depth_byte], 0x04U); // Set bit depth = 24-bit only (set bit 2, reset all others)

  // Write new information
  write_edid(edid, set_video_interface, VIDEO_INTERFACE_BYTE);
  write_edid(edid, set_sad_channel, sad_channel_byte);
  write_edid(edid, set_sad_sample_freq_data, sad_sample_freq_byte);
  write_edid(edid, set_sad_bit_depth, sad_bit_depth_byte);
  
  decode_edid(edid); // Decode and print new EDID information

  return 0;
}
